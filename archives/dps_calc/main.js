window.globals = {
  attack_style: "melee",
  helm: {
    name: "",
    wiki_url: "",
    img_url: "",
    slash_atk: 0,
    stab_atk: 0,
    crush_atk: 0,
    ranged_atk: 0,
    magic_atk: 0,
    melee_str: 0,
    ranged_str: 0,
    magic_str: 0,
    slash_def: 0,
    stab_def: 0,
    crush_def: 0,
    ranged_def: 0,
    magic_def: 0,
    prayer: 0,
  },
  cape: {
    name: "",
    wiki_url: "",
    img_url: "",
    slash_atk: 0,
    stab_atk: 0,
    crush_atk: 0,
    ranged_atk: 0,
    magic_atk: 0,
    melee_str: 0,
    ranged_str: 0,
    magic_str: 0,
    slash_def: 0,
    stab_def: 0,
    crush_def: 0,
    ranged_def: 0,
    magic_def: 0,
    prayer: 0,
  },
  necklace: {
    name: "",
    wiki_url: "",
    img_url: "",
    slash_atk: 0,
    stab_atk: 0,
    crush_atk: 0,
    ranged_atk: 0,
    magic_atk: 0,
    melee_str: 0,
    ranged_str: 0,
    magic_str: 0,
    slash_def: 0,
    stab_def: 0,
    crush_def: 0,
    ranged_def: 0,
    magic_def: 0,
    prayer: 0,
  },
  ammunition: {
    name: "",
    wiki_url: "",
    img_url: "",
    slash_atk: 0,
    stab_atk: 0,
    crush_atk: 0,
    ranged_atk: 0,
    magic_atk: 0,
    melee_str: 0,
    ranged_str: 0,
    magic_str: 0,
    slash_def: 0,
    stab_def: 0,
    crush_def: 0,
    ranged_def: 0,
    magic_def: 0,
    prayer: 0,
  },
  weapon: {
    name: "",
    wiki_url: "",
    img_url: "",
    slash_atk: 0,
    stab_atk: 0,
    crush_atk: 0,
    ranged_atk: 0,
    magic_atk: 0,
    melee_str: 0,
    ranged_str: 0,
    magic_str: 0,
    slash_def: 0,
    stab_def: 0,
    crush_def: 0,
    ranged_def: 0,
    magic_def: 0,
    prayer: 0,
  },
  body: {
    name: "",
    wiki_url: "",
    img_url: "",
    slash_atk: 0,
    stab_atk: 0,
    crush_atk: 0,
    ranged_atk: 0,
    magic_atk: 0,
    melee_str: 0,
    ranged_str: 0,
    magic_str: 0,
    slash_def: 0,
    stab_def: 0,
    crush_def: 0,
    ranged_def: 0,
    magic_def: 0,
    prayer: 0,
  },
  shield: {
    name: "",
    wiki_url: "",
    img_url: "",
    slash_atk: 0,
    stab_atk: 0,
    crush_atk: 0,
    ranged_atk: 0,
    magic_atk: 0,
    melee_str: 0,
    ranged_str: 0,
    magic_str: 0,
    slash_def: 0,
    stab_def: 0,
    crush_def: 0,
    ranged_def: 0,
    magic_def: 0,
    prayer: 0,
  },
  legs: {
    name: "",
    wiki_url: "",
    img_url: "",
    slash_atk: 0,
    stab_atk: 0,
    crush_atk: 0,
    ranged_atk: 0,
    magic_atk: 0,
    melee_str: 0,
    ranged_str: 0,
    magic_str: 0,
    slash_def: 0,
    stab_def: 0,
    crush_def: 0,
    ranged_def: 0,
    magic_def: 0,
    prayer: 0,
  },
  hands: {
    name: "",
    wiki_url: "",
    img_url: "",
    slash_atk: 0,
    stab_atk: 0,
    crush_atk: 0,
    ranged_atk: 0,
    magic_atk: 0,
    melee_str: 0,
    ranged_str: 0,
    magic_str: 0,
    slash_def: 0,
    stab_def: 0,
    crush_def: 0,
    ranged_def: 0,
    magic_def: 0,
    prayer: 0,
  },
  feet: {
    name: "",
    wiki_url: "",
    img_url: "",
    slash_atk: 0,
    stab_atk: 0,
    crush_atk: 0,
    ranged_atk: 0,
    magic_atk: 0,
    melee_str: 0,
    ranged_str: 0,
    magic_str: 0,
    slash_def: 0,
    stab_def: 0,
    crush_def: 0,
    ranged_def: 0,
    magic_def: 0,
    prayer: 0,
  },
  ring: {
    name: "",
    wiki_url: "",
    img_url: "",
    slash_atk: 0,
    stab_atk: 0,
    crush_atk: 0,
    ranged_atk: 0,
    magic_atk: 0,
    melee_str: 0,
    ranged_str: 0,
    magic_str: 0,
    slash_def: 0,
    stab_def: 0,
    crush_def: 0,
    ranged_def: 0,
    magic_def: 0,
    prayer: 0,
  },
  player_bonuses: {
    slash_atk: 0,
    stab_atk: 0,
    crush_atk: 0,
    ranged_atk: 0,
    magic_atk: 0,
    melee_str: 0,
    ranged_str: 0,
    magic_str: 0,
    slash_def: 0,
    stab_def: 0,
    crush_def: 0,
    ranged_def: 0,
    magic_def: 0,
    prayer: 0,
  },
  player_effective_stats: {
    attack: 1,
    strength: 1,
    defense: 1,
    ranged: 1,
    magic: 1,
    melee_attack_prayer: 0,
    melee_strength_prayer: 0,
    melee_style_bonus: 0,
    melee_other: 0,
    ranged_accuracy_prayer: 0,
    ranged_strength_prayer: 0,
    magic_prayer: 0,
  },
  opponent_bonuses_and_stats: {
    def_level: 1,
    magic_level: 1,
    slash_def: 0,
    stab_def: 0,
    crush_def: 0,
    ranged_def: 0,
    magic_def: 0,
  }
}


/* LEFT OFF HERE SEE https://www.reddit.com/r/2007scape/comments/40bvk6/accuracy_and_exphr_combat_formula/ */
// function default_hit_chance() {
//   const melee_attack_level = globals.player_effective_stats.attack;
//   const melee_attack_prayer = (1 + globals.player_effective_stats.melee_attack_prayer);
//   const melee_style_bonus = globals.player_effective_stats.melee_style_bonus;
//   const melee_other = (1 + globals.player_effective_stats.melee_other);
//   const effective_attack_level = Math.floor(melee_attack_level * melee_attack_prayer * melee_other + 8 + melee_style_bonus);
//   let player_melee_bonus;
//   // if(globals.attack_style == "") {

//   // }
//   const maximum_attack_roll = effective_attack_level * (globals.player_bonuses.)

//   const opponent_def_level = globals.opponent_bonuses_and_stats.def_level;
//   const opponent_style_bonus = 1;
//   const opponent_effective_defense = Math.floor(opponent_def_level + 8 + opponent_style_bonus);
// }

const select_combat_button = document.getElementById("combat-styles").children;
for (let i = 0; i < 3; i++) {
  const icon = select_combat_button[i];
  icon.addEventListener("click", function () {
    const value = icon.getAttribute("value");
    globals.attack_style = value;
    const dropdowns = document.getElementsByClassName("select-style");
    for (let j = 0; j < dropdowns.length; j++) {
      dropdowns[j].classList.add("select-hidden");
    }
    if (value == "melee") {
      select_combat_button[0].children[0].classList.add("selected");
      select_combat_button[1].children[0].classList.remove("selected");
      select_combat_button[2].children[0].classList.remove("selected");
      const dropdown = document.getElementsByClassName("select melee")[0];
      dropdown.classList.remove("select-hidden");
    } else if (value == "ranged") {
      select_combat_button[0].children[0].classList.remove("selected");
      select_combat_button[1].children[0].classList.add("selected");
      select_combat_button[2].children[0].classList.remove("selected");
      const dropdown = document.getElementsByClassName("select ranged")[0];
      dropdown.classList.remove("select-hidden");
    } else {
      select_combat_button[0].children[0].classList.remove("selected");
      select_combat_button[1].children[0].classList.remove("selected");
      select_combat_button[2].children[0].classList.add("selected");
      const dropdown = document.getElementsByClassName("select magic")[0];
      dropdown.classList.remove("select-hidden");
    }
  })
}

["helm", "cape", "necklace", "ammunition", "weapon", "body", "shield", "legs", "hands", "feet", "ring"].forEach(name => {
  const select_name = `select-${name}`;
  const select = document.getElementById(select_name);
  const select_input = document.getElementById(`select-${name}-input`);
  select_input.value = "";
  const select_input_container = document.getElementById(`select-${name}-datalist-container`);
  const slot_equipment = equipment[name];
  const gear_list = Object.keys(slot_equipment);
  for (let i = 0; i < gear_list.length; i++) {
    const option = document.createElement("option");
    option.value = gear_list[i];
    select.appendChild(option);
  };
  if (name == "weapon") {
    const two_hand_gear_list = Object.keys(equipment.two_hand);
    for (let i = 0; i < gear_list.length; i++) {
      const option = document.createElement("option");
      option.value = two_hand_gear_list[i];
      select.appendChild(option);
    };
  }
  const container_name = `select-${name}-container`;
  const container = document.getElementById(container_name);
  container.addEventListener("click", function () {
    const hide = document.getElementsByClassName("gear-label");
    for (let i = 0; i < hide.length; i++) {
      hide[i].classList.add("list-hidden");
    }
    select_input_container.classList.remove("list-hidden");
    const inp = select_input_container.getElementsByTagName("input")[0];
    inp.focus();
  })
})


const input_selects = document.getElementsByClassName("input-select");

for (let i = 0; i < input_selects.length; i++) {
  const select = input_selects[i];
  select.addEventListener("keyup", function (e) {
    if (e.code === "Enter") {
      const hide = document.getElementsByClassName("gear-label");
      for (let i = 0; i < hide.length; i++) {
        hide[i].classList.add("list-hidden");
      }
    }
  });
  window.execute_change_event = true; // This prevents an event loop for two-handed items
  select.addEventListener("change", function () {
    const hide = document.getElementsByClassName("gear-label");
    const equipment_piece = select.value;
    for (let i = 0; i < hide.length; i++) {
      hide[i].classList.add("list-hidden");
    };
    const slot = select.getAttribute("name");
    const img_elt = document.getElementById(`${slot}-thumbnail`);
    const default_stats = {
      slash_atk: 0,
      stab_atk: 0,
      crush_atk: 0,
      ranged_atk: 0,
      magic_atk: 0,
      melee_str: 0,
      ranged_str: 0,
      magic_str: 0,
      slash_def: 0,
      stab_def: 0,
      crush_def: 0,
      ranged_def: 0,
      magic_def: 0,
      prayer: 0,
    }
    const data = equipment[slot][equipment_piece] || equipment["two_hand"][equipment_piece] || default_stats;
    let img_src, wiki_url, name;
    if (data == undefined || data === default_stats) {
      img_src = "none";
      wiki_src = "";
      name = "none";
      wiki_url = "#";
    } else {
      img_src = "data:image/jpeg;base64, " + data.image_data;
      wiki_url = data.wiki_url;
      name = equipment_piece;
      wiki_url = data.wiki_url;
    }

    if (Object.keys(equipment["two_hand"]).includes(equipment_piece)) {
      if (execute_change_event == true) {
        const shield_input = document.getElementById("select-shield-input");
        shield_input.value = "";
        let evt = new CustomEvent('change');
        execute_change_event = false;
        shield_input.dispatchEvent(evt);
      }
    }

    execute_change_event = true;

    img_elt.setAttribute("src", img_src);

    const bonuses_list = [
      "slash_atk",
      "stab_atk",
      "crush_atk",
      "ranged_atk",
      "magic_atk",
      "melee_str",
      "ranged_str",
      "magic_str",
      "slash_def",
      "stab_def",
      "crush_def",
      "ranged_def",
      "magic_def",
      "prayer",
    ];

    bonuses_list.forEach(bonus => {
      globals[slot][bonus] = Number(data[bonus]) || 0;
    })
    globals[slot]["name"] = name;
    globals[slot]["wiki_url"] = wiki_url;
    globals[slot]["img_url"] = img_src;
    updateGearStatsText();
  })
  select.addEventListener("input", function (e) {
    if (e.inputType === "insertReplacementText") {
      let evt = new CustomEvent('change');
      select.dispatchEvent(evt);
    }
  })
}

document.body.addEventListener("mousedown", function (e) {
  let exit = true;
  let target = e.target;
  if (e.target.classList.contains("input-select") || e.target.classList.contains("gear-image-container")) {
    exit = false;
  }
  if (exit) {
    const hide = document.getElementsByClassName("gear-label");
    for (let i = 0; i < hide.length; i++) {
      hide[i].classList.add("list-hidden");
    }
  }
});


document.getElementById("display-name").addEventListener("keydown", (e) => {
  if (e.key == "Enter") {
    fetch_stats()
  }
})

function updateGearStatsText() {

  const slots = [
    "helm",
    "cape",
    "necklace",
    "ammunition",
    "weapon",
    "body",
    "shield",
    "legs",
    "hands",
    "feet",
    "ring"
  ]

  const bonuses_list = [
    "slash_atk",
    "stab_atk",
    "crush_atk",
    "ranged_atk",
    "magic_atk",
    "melee_str",
    "ranged_str",
    "magic_str",
    "slash_def",
    "stab_def",
    "crush_def",
    "ranged_def",
    "magic_def",
    "prayer",
  ];

  const ids = [
    "slash-atk-value",
    "stab-atk-value",
    "crush-atk-value",
    "ranged-atk-value",
    "magic-atk-value",
    "melee-str-value",
    "ranged-str-value",
    "magic-str-value",
    "slash-def-value",
    "stab-def-value",
    "crush-def-value",
    "ranged-def-value",
    "magic-def-value",
    "prayer-value",
  ];

  bonuses_list.forEach((bonus, i) => {
    let value = 0;
    slots.forEach(slot => {
      value += Number(globals[slot][bonus]);
    })
    globals.player_bonuses[bonus] = value;
    let sign = value >= 0 ? "+" : "";
    value = sign + String(value);
    if (bonus === "magic_str") {
      value += "%"
    }
    document.getElementById(ids[i]).innerHTML = value;
  })

}

const set = {
  items: ["Diamond bolts (e)"],
  attack_style: "ranged",
  dps_function: function () {

  }
}

function check_for_set_effects() {
  const equipment_names = {
    "helm": globals.helm.name,
    "cape": globals.cape.name,
    "necklace": globals.necklace.name,
    "ammunition": globals.ammunition.name,
    "weapon": globals.weapon.name,
    "body": globals.body.name,
    "shield": globals.shield.name,
    "legs": globals.legs.name,
    "hands": globals.hands.name,
    "feet": globals.feet.name,
    "ring": globals.ring.name,
  }

  let equipment_names_list = [];
  const equipped_items = Object.values(equipment_names);
  for (i in equipped_items) {
    if (equipped_items[i] !== "") {
      equipment_names_list.push(equipped_items[i])
    }
  }

}

const weapon_types = [
  "bow",
  "spear",
  "2h_sword",
  "scythe",
  "claw",
  "polearm",
  "unarmed",
  "blunt",
  "axe",
  "crossbow",
  "spiked",
  "gun",
  "staff",
  "polestaff",
  "salamander",
  "slash_sword",
  "thrown",
  "bludgeon",
  "bulwark",
  "stab_sword",
  "powered_staff",
  "banner",
  "pickaxe",
  "whip",
  "chinchompas",
  "bladed_staff"
];

const monster_select_datalist = document.getElementById("monster-select-datalist");
const monster_names = Object.keys(monsters);
monster_names.forEach(monster_name => {
  // const monster = monsters[monster_name];
  const option = document.createElement("option");
  option.value = monster_name;
  option.innerHTML = monster_name;
  monster_select_datalist.appendChild(option);
})

document.getElementById("select-magic-spell").value = "wind-strike";